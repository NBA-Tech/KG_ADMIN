<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0" />
  <meta name="description" content="Preskool - Bootstrap Admin Template" />
  <meta name="keywords" content="admin, estimates, bootstrap, business, html5, responsive, Projects" />
  <meta name="author" content="Dreams technologies - Bootstrap Admin Template" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Preskool Admin Template</title>

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="assets/img/favicon.png" />

  <!-- Theme Script -->
  <script src="assets/js/theme-script.js" type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="assets/css/bootstrap.min.css" />

  <!-- Feather CSS -->
  <link rel="stylesheet" href="assets/plugins/icons/feather/feather.css" />

  <!-- Tabler Icon CSS -->
  <link rel="stylesheet" href="assets/plugins/tabler-icons/tabler-icons.css" />

  <!-- Daterangepikcer CSS -->
  <link rel="stylesheet" href="assets/plugins/daterangepicker/daterangepicker.css" />

  <!-- Fontawesome CSS -->
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/fontawesome.min.css" />
  <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css" />

  <!-- Select2 CSS -->
  <link rel="stylesheet" href="assets/plugins/select2/css/select2.min.css" />

  <!-- Datetimepicker CSS -->
  <link rel="stylesheet" href="assets/css/bootstrap-datetimepicker.min.css" />

  <!-- Bootstrap Tagsinput CSS -->
  <link rel="stylesheet" href="assets/plugins/bootstrap-tagsinput/bootstrap-tagsinput.css" />

  <!-- Main CSS -->
  <link rel="stylesheet" href="assets/css/style.css" />
</head>

<body>
  <!-- Main Wrapper -->
  <div class="main-wrapper">
    <!-- Header -->
    <%- include('header') %>
    <!-- /Header -->

    <!-- Sidebar -->
   <%- include('sidebar') %>
    <!-- /Sidebar -->

    <!-- Page Wrapper -->
    <div class="page-wrapper">
      <div class="content content-two">
        <!-- Page Header -->
        <div class="d-md-flex d-block align-items-center justify-content-between mb-3">
          <div class="my-auto mb-2">
            <h3 class="mb-1">Add Student</h3>
            <nav>
              <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                  <a href="index.html">Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                  <a href="teachers.html">Student</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                  Add Student
                </li>
              </ol>
            </nav>
          </div>
        </div>
        <!-- /Page Header -->

        <div class="row">
          <div class="col-md-12">
            <form action="teachers.html" id="studentForm">
              <!-- Personal Information -->
              <div class="card">
                <div class="card-body pb-1">
                  <div class="row row-cols-xxl-5 row-cols-md-6">
                    <div class="col">
                      <div class="mb-3">
                        <label class="form-label">Student ID</label>
                        <input type="text" name="student_id" id="student_id" class="form-control"
                          placeholder="Auto Filled" readonly />
                      </div>
                    </div>
                    <div class="col">
                      <div class="mb-3">
                        <label class="form-label">First Name</label>
                        <input type="text" name="first_name" id="first_name" class="form-control"
                          placeholder="Eg: John" />
                      </div>
                    </div>
                    <div class="col">
                      <div class="mb-3">
                        <label class="form-label">Last Name</label>
                        <input type="text" name="last_name" id="last_name" class="form-control" placeholder="Eg: Doe" />
                      </div>
                    </div>
                    <div class="col">
                      <div class="mb-3">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" name="date_of_birth" id="date_of_birth" class="form-control"
                          placeholder="Eg: 21-10-1999" />
                      </div>
                    </div>
                    <div class="col">
                      <div class="mb-3">
                        <label class="form-label">Gender</label>
                        <select name="gender" id="gender" class="select form-select">
                          <option value="">Select</option>
                          <option value="male">Male</option>
                          <option value="female">Female</option>
                          <option value="other">Other</option>
                        </select>
                      </div>
                    </div>
                    <div class="col">
                      <div class="mb-3">
                        <label class="form-label">Blood Group</label>
                        <input type="text" name="blood_group" id="blood_group" class="form-control"
                          placeholder="Eg: O+ve" />
                      </div>
                    </div>

                    <div class="col">
                      <div class="mb-3">
                        <label class="form-label">Religion</label>
                        <input type="text" name="religion" id="religion" class="form-control" placeholder="Eg: hindu" />
                      </div>
                    </div>

                    <div class="col">
                      <div class="mb-3">
                        <label class="form-label">Caste</label>
                        <input type="text" name="caste" id="caste" class="form-control" placeholder="Eg: general" />
                      </div>
                    </div>

                     <div class="col">
                      <div class="mb-3">
                        <label class="form-label">Mother Tongue</label>
                        <input type="text" name="mother_tongue" id="mother_tongue" class="form-control" placeholder="Eg: hindi" />
                      </div>
                    </div>

                  </div>
                </div>
              </div>
              <!-- Guardian Information -->
              <div class="card">
                <div class="card-body pb-1">
                  <div class="row">
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Father's Name</label>
                        <input type="text" name="father_name" id="father_name" class="form-control"
                          placeholder="Eg: John Doe" />
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Mother's Name</label>
                        <input type="text" name="mother_name" id="mother_name" class="form-control"
                          placeholder="Eg: Jane Doe" />
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Guardian Contact No</label>
                        <input type="text" name="guardian_contact_no" id="guardian_contact_no" class="form-control"
                          placeholder="Eg: 1234567890" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Academic Details -->
              <div class="card">
                <div class="card-body pb-1">
                  <div class="row">
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Class</label>
                        <select name="class_name" id="class_name" class="select form-select">
                          <option>Select</option>
                          <option>Nursery</option>
                          <option>Grade 1</option>
                          <option>Grade 2</option>
                          <option>Grade 10</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Section</label>
                        <select name="section" id="section" class="select form-select">
                          <option>Select</option>
                          <option>A</option>
                          <option>B</option>
                          <option>C</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Roll Number</label>
                        <input type="text" name="roll_no" id="roll_no" class="form-control" placeholder="Eg: 1" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Contact & Address -->
              <div class="card">
                <div class="card-body pb-1">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Email Address(Parent)</label>
                        <input type="email" name="email" id="email" class="form-control"
                          placeholder="Eg: 6V5D1@example.com" />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Mobile Number(Parent)</label>
                        <input type="text" name="parent_contact_no" id="parent_contact_no" class="form-control"
                          placeholder="Eg: 1234567890" />
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="mb-3">
                        <label class="form-label">Current Address</label>
                        <input type="text" name="address" id="address" class="form-control"
                          placeholder="Eg: 123, Street, City, Country" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card-body pb-1">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Email Address(Parent)</label>
                        <input type="email" name="email" id="email" class="form-control"
                          placeholder="Eg: 6V5D1@example.com" />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Mobile Number(Parent)</label>
                        <input type="text" name="parent_contact_no" id="parent_contact_no" class="form-control"
                          placeholder="Eg: 1234567890" />
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="mb-3">
                        <label class="form-label">Current Address</label>
                        <input type="text" name="address" id="address" class="form-control"
                          placeholder="Eg: 123, Street, City, Country" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card-body pb-1">
                  <div class="row">
                    <div class="mb-3 row">
                      <label class="form-label col-md-2">Other Notes</label>
                      <div class="col-md-10">
                        <textarea rows="5" cols="5" class="form-control" name="other_notes" placeholder="Enter text here"></textarea>
                      </div>
                    </div>


                  </div>
                </div>
              </div>
              <!-- Documents -->
              <div class="card">
                <div class="card-body pb-1">
                  <div class="row">
                    <div class="col-md-6">
                      <label class="form-label">Upload Student Photo</label>
                      <input type="file" name="student_profile_photo" id="student_profile_photo" class="form-control" />
                      <small class="text-muted">Max size 4MB. JPG/PNG only.</small>
                      <div id="student_profile_photo_preview"></div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Upload Birth Certificate</label>
                      <input type="file" name="student_birth_certificate" id="student_birth_certificate"
                        class="form-control" />
                      <small class="text-muted">Max size 4MB. PDF only.</small>
                      <div id="student_birth_certificate_preview"></div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Action Buttons -->
              <div class="text-end mt-3">
                <button type="button" class="btn btn-light me-3">
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary" id="add-student-btn">
                  Add Student
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- /Page Wrapper -->
  </div>
  <!-- /Main Wrapper -->

  <!-- jQuery -->
  <script src="js/api.js">

  </script>
  <script src="assets/js/jquery-3.7.1.min.js" type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>

  <!-- Bootstrap Core JS -->
  <script src="assets/js/bootstrap.bundle.min.js" type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>

  <!-- Daterangepikcer JS -->
  <script src="assets/js/moment.js" type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>
  <script src="assets/plugins/daterangepicker/daterangepicker.js"
    type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>

  <!-- Feather Icon JS -->
  <script src="assets/js/feather.min.js" type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>

  <!-- Slimscroll JS -->
  <script src="assets/js/jquery.slimscroll.min.js" type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>

  <!-- Select2 JS -->
  <script src="assets/plugins/select2/js/select2.min.js" type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>

  <!-- Datetimepicker JS -->
  <script src="assets/js/moment.js" type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>
  <script src="assets/js/bootstrap-datetimepicker.min.js" type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>

  <!-- Bootstrap Tagsinput JS -->
  <script src="assets/plugins/bootstrap-tagsinput/bootstrap-tagsinput.js"
    type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>

  <!-- Custom JS -->
  <script src="assets/js/script.js" type="6dc0a9d0ac43462e72fa7502-text/javascript"></script>

  <script src="/cdn-cgi/scripts/7d0fa10a/cloudflare-static/rocket-loader.min.js"
    data-cf-settings="6dc0a9d0ac43462e72fa7502-|49" defer></script>
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015"
    integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ=="
    data-cf-beacon='{"rayId":"95d12b338917a908","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.6.2","token":"3ca157e612a14eccbb30cf6db6691c29"}'
    crossorigin="anonymous"></script>

  <script>
    const BACKEND_URL = "<%= BACKEND_URL %>";
    let student_image_uri = undefined
    let birth_certificate = undefined

    const uploadFile = async (file, image_path) => {

      const father_name = document.getElementById("father_name").value
      const first_name = document.getElementById("first_name").value

      const formData = new FormData()
      formData.append("file", file)
      formData.append("image_path", image_path + first_name + father_name)

      const uploadRequest = await fetchWithTimeout(
        `${BACKEND_URL}/store/upload_file`,
        {
          method: "POST",
          body: formData
        },
      )

      const uploadResponse = await uploadRequest.json()

      if (!uploadResponse.success) {
        //handle error
        alert(uploadResponse.message)
        return ""
      }
      else {
        //handleSucces
        return uploadResponse?.image_url
      }

    }
    document
      .getElementById("add-student-btn")
      .addEventListener("click", async function (event) {
        event.preventDefault();
        // Here you can add your form submission logic
        const formElement = document.getElementById("studentForm");
        const formData = new FormData(formElement);

        // Flatten form fields
        let jsonObject = {};
        for (const [key, value] of formData.entries()) {
          jsonObject[key] = value instanceof File ? value.name : value;
        }

        // Validate uploads
        if (!student_image_uri || !birth_certificate) {
          alert("Please upload student image and birth certificate");
          return;
        }

        // Set uploaded file URIs
        jsonObject["student_profile_photo"] = student_image_uri;
        jsonObject["student_birth_certificate"] = birth_certificate;

        // Now transform to nested structure
        const nestedObject = {
          student_id: jsonObject.student_id || "",
          first_name: jsonObject.first_name || "",
          last_name: jsonObject.last_name || "",
          address: jsonObject.address || "",
          student_profile_photo: jsonObject.student_profile_photo || "",
          student_birth_certificate: jsonObject.student_birth_certificate || "",
          gender: jsonObject.gender || "",
          date_of_birth: jsonObject.date_of_birth || "",
          blood_group: jsonObject.blood_group || "",
          religion: jsonObject.religion || "",
          caste: jsonObject.caste || "",
          other_notes: jsonObject.other_notes || "",
          mother_tongue: jsonObject.mother_tongue || "",
          student_created_on: new Date().toISOString(), // or your desired format

          student_class: {
            class_name: jsonObject.class_name || "",
            section: jsonObject.section || "",
            roll_no: jsonObject.roll_no || "",
          },

          student_parent: {
            father_name: jsonObject.father_name || "",
            mother_name: jsonObject.mother_name || "",
            parent_contact_no: jsonObject.parent_contact_no || "",
            email: jsonObject.email || "",
            guardian_contact_no: jsonObject.guardian_contact_no || "",
          },
        };

        try {
          const response = await fetch(
            `${BACKEND_URL}/students/update_new_student`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(nestedObject),
            }
          );

          const data = await response.json();

          if (data?.success) {
            showToast(
              "success",
              data?.message || "Student added successfully."
            );
          } else {
            showToast("error", data?.message || "Failed to add student.");
          }
        } catch (error) {
          console.error("Error:", error);
          showToast(
            "error",
            "Something went wrong while adding the student."
          );
        }
      });
    document.getElementById("student_birth_certificate").addEventListener("change", async function (event) {
      const file = event.target.files[0];

      if (file) {
        const maxSize = 4 * 1024 * 1024; // 4MB

        if (file.type !== "application/pdf") {
          alert("Only PDF files are allowed.");
          return;
        }

        if (file.size > maxSize) {
          alert("File size exceeds 4MB.");
          return;
        }

        const previewDiv = document.getElementById("student_birth_certificate_preview");
        previewDiv.innerHTML = `
        <div style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
          <img src="https://cdn-icons-png.flaticon.com/512/337/337946.png" alt="PDF Icon" style="width: 24px; height: 24px;" />
          <span>${file.name}</span>
        </div>
      `;

        birth_certificate = await uploadFile(file, "/student/profile/birth_certificate")
      }
    });
    document.getElementById("student_profile_photo").addEventListener("change", async function (event) {
      const file = event.target.files[0];

      if (file) {
        const allowedTypes = ["image/jpeg", "image/png"];
        const maxSize = 4 * 1024 * 1024; // 4MB

        if (!allowedTypes.includes(file.type)) {
          alert("Only JPG or PNG files are allowed.");
          return;
        }

        if (file.size > maxSize) {
          alert("File size exceeds 4MB.");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const previewDiv = document.getElementById("student_profile_photo_preview");
          previewDiv.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 100%; height: auto; margin-top: 10px;" />`;
        };

        reader.readAsDataURL(file);

        student_image_uri = await uploadFile(file, "/student/profile/photo")


      }
    });
  </script>

</body>

</html>